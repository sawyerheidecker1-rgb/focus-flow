<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus-Flow | Productive Noir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --card-dark: #18181b;
            --electric-violet: #8b5cf6;
            --violet-glow: rgba(139, 92, 246, 0.3);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #f4f4f5;
            overflow-x: hidden;
        }
        .violet-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }
        .card-glow:hover {
            box-shadow: 0 0 20px var(--violet-glow);
            border-color: var(--electric-violet);
        }
        .glass {
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 10px;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="onboardingModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="glass max-w-md w-full p-8 rounded-3xl text-center">
            <div class="w-16 h-16 violet-gradient rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-violet-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="text-white w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">Welcome to Focus-Flow</h2>
            <p class="text-zinc-400 mb-8">Master your routine with high-performance tracking and deep focus tools.</p>
            <button onclick="closeOnboarding()" class="w-full py-4 violet-gradient rounded-xl font-bold hover:opacity-90 transition-all">Start My Journey</button>
        </div>
    </div>

    <main class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-white">FOCUS<span class="text-violet-500">FLOW</span></h1>
                <p id="quoteDisplay" class="text-zinc-500 italic mt-1 text-sm">"The secret of your future is hidden in your daily routine."</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openSettings()" class="p-3 glass rounded-xl hover:bg-zinc-800 transition-colors">
                <!-- XP/Level/Coins Display -->
                <div class="flex items-center gap-4 mr-4">
                    <!-- Level Badge -->
                    <div class="flex items-center gap-2 px-4 py-2 bg-zinc-800/50 rounded-xl border border-violet-500/30">
                        <span class="text-xs text-zinc-400">LEVEL</span>
                        <span id="levelDisplay" class="text-xl font-bold text-violet-400">1</span>
                        <span id="levelNameDisplay" class="text-xs text-zinc-500">Bronze</span>
                    </div>
                    <!-- XP Progress -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-zinc-400">XP</span>
                            <span id="xpDisplay" class="text-sm font-bold text-white">0</span>
                            <span class="text-xs text-zinc-500">/</span>
                            <span id="nextLevelXP" class="text-xs text-zinc-500">100</span>
                        </div>
                        <div class="w-32 h-2 bg-zinc-800 rounded-full overflow-hidden">
                            <div id="xpProgressBar" class="h-full bg-gradient-to-r from-violet-600 to-violet-400 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Coins -->
                    <div class="flex items-center gap-2 px-4 py-2 bg-zinc-800/50 rounded-xl border border-yellow-500/30">
                        <span class="text-xl">ðŸ’°</span>
                        <span id="coinsDisplay" class="text-lg font-bold text-yellow-400">0</span>
                    </div>
                </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <button onclick="toggleModal('habitModal', true)" class="px-6 py-3 violet-gradient rounded-xl font-bold shadow-lg shadow-violet-500/20 hover:scale-105 transition-transform">+ New Habit</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-8">
                <section>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            Active Habits <span id="habitCount" class="text-sm bg-zinc-800 px-2 py-0.5 rounded-full text-zinc-400">0</span>
                        </h2>
                    </div>
                    <div id="habitsList" class="grid gap-4">
                        <div id="emptyState" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-zinc-800">
                            <p class="text-zinc-500">No habits tracked yet. Start your first one today!</p>
                        </div>
                    </div>
                </section>

                <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass p-5 rounded-2xl">
                        <p class="text-zinc-500 text-xs uppercase font-bold tracking-widest mb-1">Total Streaks</p>
                        <p id="statTotalStreaks" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="glass p-5 rounded-2xl">
                        <p class="text-zinc-500 text-xs uppercase font-bold tracking-widest mb-1">Today's Rate</p>
                        <p id="statCompletionRate" class="text-2xl font-bold">0%</p>
                    </div>
                    <div class="glass p-5 rounded-2xl">
                        <p class="text-zinc-500 text-xs uppercase font-bold tracking-widest mb-1">Best Habit</p>
                        <p id="statBestHabit" class="text-sm font-bold truncate">None</p>
                    </div>
                    <div class="glass p-5 rounded-2xl border-violet-500/30">
                        <p class="text-zinc-500 text-xs uppercase font-bold tracking-widest mb-1">Focus Mins</p>
                        <p id="statFocusTime" class="text-2xl font-bold">0</p>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-4 space-y-8">
                <section class="glass p-8 rounded-3xl text-center relative overflow-hidden border-violet-500/20">
                    <div class="relative z-10">
                        <div class="flex justify-center gap-2 mb-6">
                            <button onclick="setTimer(25)" class="px-3 py-1 text-xs rounded-full bg-zinc-800 hover:bg-violet-600 transition-colors">Work</button>
                            <button onclick="setTimer(5)" class="px-3 py-1 text-xs rounded-full bg-zinc-800 hover:bg-violet-600 transition-colors">Short</button>
                            <button onclick="setTimer(15)" class="px-3 py-1 text-xs rounded-full bg-zinc-800 hover:bg-violet-600 transition-colors">Long</button>
                        </div>
                        <h3 id="timerDisplay" class="text-6xl font-black mb-6 tabular-nums tracking-tight">25:00</h3>
                        <div class="flex gap-3 justify-center">
                            <button id="timerBtn" onclick="toggleTimer()" class="w-full py-3 violet-gradient rounded-xl font-bold">Start</button>
                            <button onclick="resetTimer()" class="px-4 py-3 bg-zinc-800 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            </button>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-3xl">
                    <h3 class="font-bold mb-4">Weekly Activity</h3>
                    <div id="weeklyChart" class="flex items-end justify-between h-24 gap-1">
                        </div>
                    <div class="flex justify-between mt-2 text-[10px] text-zinc-500 uppercase font-bold">
                        <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <div id="habitModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="glass max-w-md w-full p-8 rounded-3xl">
            <h2 class="text-2xl font-bold mb-6">Create Habit</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Habit Name</label>
                    <input type="text" id="habitInput" placeholder="e.g. Morning Meditation" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 focus:outline-none focus:border-violet-500">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Category</label>
                    <select id="habitCategory" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 focus:outline-none focus:border-violet-500">
                        <option value="Study">Study</option>
                        <option value="Fitness">Fitness</option>
                        <option value="Wellness">Wellness</option>
                        <option value="Creative">Creative</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="toggleModal('habitModal', false)" class="flex-1 py-3 bg-zinc-800 rounded-xl font-bold">Cancel</button>
                    <button onclick="addHabit()" class="flex-1 py-3 violet-gradient rounded-xl font-bold">Save Habit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="glass max-w-md w-full p-8 rounded-3xl">
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <span>Sound Notifications</span>
                    <input type="checkbox" id="soundToggle" checked class="accent-violet-500 h-5 w-5">
                </div>
                <div class="pt-4 border-t border-zinc-800">
                    <button onclick="exportData()" class="w-full py-3 mb-3 bg-zinc-800 rounded-xl text-sm font-bold">Export Data (JSON)</button>
                    <button onclick="clearAllData()" class="w-full py-3 bg-red-900/20 text-red-500 border border-red-900/50 rounded-xl text-sm font-bold">Reset All App Data</button>
                </div>
                <button onclick="toggleModal('settingsModal', false)" class="w-full py-3 bg-zinc-700 rounded-xl font-bold mt-4">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- APP STATE ---
        let state = {
            habits: [],
            stats: { focusSessions: 0, totalFocusMinutes: 0 },
    xp: 0,
    level: 1,
    levelName: 'Bronze',
    coins: 0,
    badges: [],
    dailyLoginStreak: 0,
    lastLoginDate: null,
    dailyRewardClaimed: false,
    lootBoxes: { common: 0, rare: 0, legendary: 0 },
    totalHabitsCompleted: 0,
    currentDailyChallenge: null,
            settings: { soundEnabled: true, onboardingComplete: false },
            lastDate: new Date().toLocaleDateString()
        };

        const QUOTES = [
            "Discipline is choosing between what you want now and what you want most.",
            "You do not rise to the level of your goals. You fall to the level of your systems.",
            "Small habits make a big difference.",
            "Motivation is what gets you started. Habit is what keeps you going."
        ];

        // --- CORE LOGIC ---
        function init() {
            const savedState = localStorage.getItem('focusFlow_data');
            if (savedState) {
                state = JSON.parse(savedState);
                checkDailyReset();
            checkDailyLogin();
            } else {
                document.getElementById('onboardingModal').classList.remove('hidden');
            }
            
            renderHabits();
            updateStats();
            renderWeeklyChart();
            document.getElementById('quoteDisplay').innerText = `"${QUOTES[Math.floor(Math.random() * QUOTES.length)]}"`;
        }


    // --- XP & LEVELING SYSTEM ---
    const LEVEL_THRESHOLDS = {
        1: { name: 'Bronze', xpRequired: 0 },
        2: { name: 'Silver', xpRequired: 100 },
        3: { name: 'Gold', xpRequired: 300 },
        4: { name: 'Platinum', xpRequired: 600 },
        5: { name: 'Diamond', xpRequired: 1000 }
    };

    function awardXP(amount) {
        state.xp += amount;
        checkLevelUp();
        saveData();
        updateStats();
    }

    function checkLevelUp() {
        const levels = Object.keys(LEVEL_THRESHOLDS).map(Number).sort((a, b) => b - a);
        for (let level of levels) {
            if (state.xp >= LEVEL_THRESHOLDS[level].xpRequired) {
                if (state.level < level) {
                    state.level = level;
                    state.levelName = LEVEL_THRESHOLDS[level].name;
                    showLevelUpCelebration();
                }
                break;
            }
        }
    }

    function showLevelUpCelebration() {
        confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 }
        });
    }

    // --- REWARDS & GAMIFICATION SYSTEMS ---
    const BADGES = {
        FIRST_STEPS: { id: 'first_steps', name: 'First Steps', desc: 'Complete your first habit' },
        WEEK_WARRIOR: { id: 'week_warrior', name: 'Week Warrior', desc: '7-day streak' },
        STUDY_GRIND: { id: 'study_grind', name: 'Study Grind', desc: 'Complete 50 habits' },
        NIGHT_OWL: { id: 'night_owl', name: 'Night Owl', desc: 'Complete habit after 10 PM' },
        EARLY_BIRD: { id: 'early_bird', name: 'Early Bird', desc: 'Complete habit before 7 AM' },
        POMODORO_MASTER: { id: 'pomodoro_master', name: 'Pomodoro Master', desc: '25 focus sessions' },
        DIAMOND_MIND: { id: 'diamond_mind', name: 'Diamond Mind', desc: 'Reach Diamond level' }
    };

    function checkBadges() {
        const earnedBadges = [];
        
        // First Steps
        if (state.totalHabitsCompleted >= 1 && !state.badges.includes('first_steps')) {
            earnedBadges.push(BADGES.FIRST_STEPS);
        }
        
        // Week Warrior - check if any habit has 7+ day streak
        const hasWeekStreak = state.habits.some(h => h.streak >= 7);
        if (hasWeekStreak && !state.badges.includes('week_warrior')) {
            earnedBadges.push(BADGES.WEEK_WARRIOR);
        }
        
        // Study Grind
        if (state.totalHabitsCompleted >= 50 && !state.badges.includes('study_grind')) {
            earnedBadges.push(BADGES.STUDY_GRIND);
        }
        
        // Pomodoro Master
        if (state.stats.focusSessions >= 25 && !state.badges.includes('pomodoro_master')) {
            earnedBadges.push(BADGES.POMODORO_MASTER);
        }
        
        // Diamond Mind
        if (state.level >= 5 && !state.badges.includes('diamond_mind')) {
            earnedBadges.push(BADGES.DIAMOND_MIND);
        }
        
        // Award new badges
        earnedBadges.forEach(badge => {
            state.badges.push(badge.id);
            showBadgeNotification(badge);
        });
    }

    function showBadgeNotification(badge) {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
    }

    const DAILY_CHALLENGES = [
        { id: 'triple_threat', name: 'Triple Threat', desc: 'Complete 3 habits today', xpReward: 50, check: () => state.habits.filter(h => h.completedToday).length >= 3 },
        { id: 'perfect_day', name: 'Perfect Day', desc: '100% completion rate', xpReward: 100, check: () => state.habits.length > 0 && state.habits.every(h => h.completedToday) }
    ];

    function checkDailyChallenge() {
        if (!state.currentDailyChallenge) {
            state.currentDailyChallenge = DAILY_CHALLENGES[Math.floor(Math.random() * DAILY_CHALLENGES.length)];
        }
        
        const challenge = state.currentDailyChallenge;
        if (challenge && challenge.check && challenge.check()) {
            awardXP(challenge.xpReward);
            state.currentDailyChallenge = null; // Reset for next day
            showBadgeNotification({ name: challenge.name + ' Complete!', desc: `+${challenge.xpReward} XP` });
        }
    }

    function checkDailyLogin() {
        const today = new Date().toLocaleDateString();
        
        if (state.lastLoginDate !== today) {
            state.lastLoginDate = today;
            state.dailyLoginStreak++;
            state.dailyRewardClaimed = false;
            
            // Award daily login reward
            const rewards = [20, 30, 50, 50, 100, 75, 200]; // Days 1-7
            const dayIndex = (state.dailyLoginStreak - 1) % 7;
            const xpReward = rewards[dayIndex];
            
            awardXP(xpReward);
            state.coins += Math.floor(xpReward / 2); // Half XP amount in coins
            
            if (dayIndex === 6) { // Day 7 - Legendary reward
                state.lootBoxes.legendary++;
            } else if (dayIndex === 4) { // Day 5 - Rare
                state.lootBoxes.rare++;
            } else if (dayIndex === 2) { // Day 3 - Common
                state.lootBoxes.common++;
            }
            
            saveData();
        }
    }

        function saveData() {
            localStorage.setItem('focusFlow_data', JSON.stringify(state));
            updateStats();
            renderWeeklyChart();
        }

        // --- HABIT MANAGEMENT ---
        function addHabit() {
            const name = document.getElementById('habitInput').value;
            const category = document.getElementById('habitCategory').value;
            
            if (!name) return;

            const newHabit = {
                id: Date.now(),
                name,
                category,
                streak: 0,
                maxStreak: 0,
                completedToday: false,
                history: [] // Stores ISO dates of completion
            };

            state.habits.push(newHabit);
            saveData();
            renderHabits();
            toggleModal('habitModal', false);
            document.getElementById('habitInput').value = '';
        }

        function toggleHabit(id) {
            const habit = state.habits.find(h => h.id === id);
            const today = new Date().toISOString().split('T')[0];

            if (!habit.completedToday) {
                habit.completedToday = true;
                habit.streak++;
                if (habit.streak > habit.maxStreak) habit.maxStreak = habit.streak;
                habit.history.push(today);
                awardXP(10); // Award 10 XP for completing a habit
                state.coins += 10; // Award 10 coins per habit
                state.totalHabitsCompleted++;
                checkBadges();
                checkDailyChallenge();
                
                // Visual feedback
                if ([7, 30, 100].includes(habit.streak)) triggerConfetti();
                playNotification();
            } else {
                habit.completedToday = false;
                habit.streak = Math.max(0, habit.streak - 1);
                habit.history = habit.history.filter(d => d !== today);
            }

            saveData();
            renderHabits();
        }

        function deleteHabit(id) {
            state.habits = state.habits.filter(h => h.id !== id);
            saveData();
            renderHabits();
        }

        // Logic to reset completion status daily and check for broken streaks
        function checkDailyReset() {
            const today = new Date().toLocaleDateString();
            if (state.lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                state.habits.forEach(habit => {
                    const didFinishYesterday = habit.history.includes(yesterdayStr);
                    if (!didFinishYesterday && habit.streak > 0) {
                        habit.streak = 0; // Reset streak if missed day
                    }
                    habit.completedToday = false;
                });
                state.lastDate = today;
                saveData();
            }
        }

        // --- UI RENDERING ---
        function renderHabits() {
            const list = document.getElementById('habitsList');
            const empty = document.getElementById('emptyState');
            
            list.innerHTML = '';
            document.getElementById('habitCount').innerText = state.habits.length;

            if (state.habits.length === 0) {
                list.appendChild(empty);
                return;
            }

            state.habits.forEach(habit => {
                const div = document.createElement('div');
                div.className = `glass p-5 rounded-2xl flex items-center justify-between card-glow transition-all animate-slide ${habit.completedToday ? 'border-violet-500/50 opacity-80' : ''}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <button onclick="toggleHabit(${habit.id})" class="w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${habit.completedToday ? 'bg-violet-500 border-violet-500' : 'border-zinc-700 hover:border-violet-500'}">
                            ${habit.completedToday ? '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                        </button>
                        <div>
                            <h3 class="font-bold ${habit.completedToday ? 'line-through text-zinc-500' : ''}">${habit.name}</h3>
                            <div class="flex gap-2 items-center">
                                <span class="text-[10px] uppercase tracking-wider text-violet-400 font-bold">${habit.category}</span>
                                <span class="text-[10px] text-zinc-500">â€¢</span>
                                <span class="text-[10px] text-zinc-400 font-medium">ðŸ”¥ ${habit.streak} day streak</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteHabit(${habit.id})" class="p-2 text-zinc-600 hover:text-red-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function updateStats() {
            const completedToday = state.habits.filter(h => h.completedToday).length;
            const rate = state.habits.length ? Math.round((completedToday / state.habits.length) * 100) : 0;
            const totalStreaks = state.habits.reduce((acc, h) => acc + h.streak, 0);
            
            const bestHabit = state.habits.length ? [...state.habits].sort((a,b) => b.maxStreak - a.maxStreak)[0].name : "None";

            document.getElementById('statCompletionRate').innerText = `${rate}%`;
            document.getElementById('statTotalStreaks').innerText = totalStreaks;
            document.getElementById('statBestHabit').innerText = bestHabit;
            document.getElementById('statFocusTime').innerText = state.stats.totalFocusMinutes;

        // Update XP/Level/Coins displays
        document.getElementById('levelDisplay').innerText = state.level;
        document.getElementById('levelNameDisplay').innerText = state.levelName;
        document.getElementById('xpDisplay').innerText = state.xp;
        document.getElementById('coinsDisplay').innerText = state.coins;
        
        // Calculate next level XP and progress
        const nextLevel = state.level + 1;
        const nextLevelThreshold = LEVEL_THRESHOLDS[nextLevel]?.xpRequired || 1000;
        const currentLevelThreshold = LEVEL_THRESHOLDS[state.level]?.xpRequired || 0;
        const xpIntoCurrentLevel = state.xp - currentLevelThreshold;
        const xpNeededForNext = nextLevelThreshold - currentLevelThreshold;
        const progressPercent = Math.min((xpIntoCurrentLevel / xpNeededForNext) * 100, 100);
        
        document.getElementById('nextLevelXP').innerText = nextLevelThreshold;
        document.getElementById('xpProgressBar').style.width = `${progressPercent}%`;
        }

        function renderWeeklyChart() {
            const chart = document.getElementById('weeklyChart');
            chart.innerHTML = '';
            
            // Mock visualization of the last 7 days
            for(let i=0; i<7; i++) {
                const height = Math.floor(Math.random() * 80) + 20; // Simulated data for demo
                const bar = document.createElement('div');
                bar.className = 'flex-1 bg-zinc-800 rounded-t-md hover:bg-violet-500 transition-all cursor-pointer group relative';
                bar.style.height = `${height}%`;
                bar.innerHTML = `<div class="absolute -top-6 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 text-[10px] bg-violet-600 px-1 rounded transition-opacity">${height}%</div>`;
                chart.appendChild(bar);
            }
        }

        // --- POMODORO LOGIC ---
        let timer;
        let timeLeft = 1500;
        let isRunning = false;

        function setTimer(mins) {
            clearInterval(timer);
            isRunning = false;
            timeLeft = mins * 60;
            updateTimerDisplay();
            document.getElementById('timerBtn').innerText = 'Start';
        }

        function toggleTimer() {
            if (isRunning) {
                clearInterval(timer);
                document.getElementById('timerBtn').innerText = 'Resume';
            } else {
                timer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        playNotification();
                        state.stats.totalFocusMinutes += 25; // Logic assumes default session
                        saveData();
                    }
                }, 1000);
                document.getElementById('timerBtn').innerText = 'Pause';
            }
            isRunning = !isRunning;
        }

        function resetTimer() {
            setTimer(25);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        // --- UTILS ---
        function toggleModal(id, show) {
            document.getElementById(id).classList.toggle('hidden', !show);
        }

        function closeOnboarding() {
            state.settings.onboardingComplete = true;
            saveData();
            toggleModal('onboardingModal', false);
        }

        function triggerConfetti() {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#8b5cf6', '#6d28d9', '#ffffff']
            });
        }

        function playNotification() {
            if (state.settings.soundEnabled) {
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.volume = 0.2;
                audio.play();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "focus_flow_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function clearAllData() {
            if(confirm("Are you absolutely sure? This will erase all habits and streaks forever.")) {
                localStorage.removeItem('focusFlow_data');
                location.reload();
            }
        }

        function openSettings() {
            document.getElementById('soundToggle').checked = state.settings.soundEnabled;
            toggleModal('settingsModal', true);
        }

        // --- LISTENERS ---
        document.getElementById('soundToggle').addEventListener('change', (e) => {
            state.settings.soundEnabled = e.target.checked;
            saveData();
        });

        // Bootstrap App
        init();

    </script>
</body>
</html>
